{% extends "base.html" %}

{% block title %}Telegram –ë–æ—Ç - WB Manager{% endblock %}

{% block extra_css %}
<style>
    .bot-container {
        padding: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }

    .status-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }

    .status-group {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        backdrop-filter: blur(10px);
    }

    .status-badge.running {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
        color: #10b981;
        border-color: rgba(16, 185, 129, 0.3);
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
    }

    .status-badge.stopped {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.3);
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
    }

    .status-badge.auth-ok {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
        color: #3b82f6;
        border-color: rgba(59, 130, 246, 0.3);
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
    }

    .status-badge.auth-fail {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
        color: #f59e0b;
        border-color: rgba(245, 158, 11, 0.3);
        box-shadow: 0 0 15px rgba(245, 158, 11, 0.2);
    }

    .status-icon {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: currentColor;
        box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        animation: pulse 2s infinite;
    }

    .status-badge.running .status-icon {
        box-shadow: 0 0 10px currentColor;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
        70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .config-section {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .config-section:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 25px rgba(0,0,0,0.25);
    }

    .section-title {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 24px;
        color: var(--text-primary);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title svg {
        color: var(--primary-color);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 500;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: inherit;
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-hint {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 6px;
    }

    .users-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .user-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: rgba(255,255,255,0.02);
        border-radius: 10px;
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .user-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-status {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }
    
    .user-status.authorized {
        color: var(--success-color);
        border: 1px solid var(--success-color);
        background: rgba(16, 185, 129, 0.1);
    }

    .btn-icon {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

    .btn-icon:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 22px;
    }

    .toggle-switch input { opacity: 0; width: 0; height: 0; }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: var(--bg-primary);
        transition: .4s;
        border-radius: 22px;
        border: 1px solid var(--border-color);
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: var(--text-secondary);
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    input:checked + .slider:before {
        transform: translateX(22px);
        background-color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="bot-container">
    <!-- Status Card -->
    <div class="status-card">
        <div class="status-group">
            <div class="status-badge" id="bot-status-badge">
                <div class="status-icon"></div>
                <span id="bot-status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
            <div class="status-badge" id="auth-status-badge" style="display: none;">
                <div class="status-icon"></div>
                <span id="auth-status-text">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è WB</span>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" id="btn-start-bot" style="display: none;">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="btn btn-danger" id="btn-stop-bot" style="display: none;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn btn-secondary" id="btn-restart-bot">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
    </div>

    <!-- Configuration -->
    <div class="config-section">
        <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        
        <div class="form-group">
            <label class="form-label">Telegram Token</label>
            <div style="display: flex; gap: 10px;">
                <input type="password" class="form-input" id="config-token" placeholder="123456789:ABCdef...">
                <button class="btn btn-secondary" onclick="togglePassword('config-token')">üëÅÔ∏è</button>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤–æ–∫</label>
            <textarea class="form-input" id="config-auth-msg" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="3" style="resize: vertical;"></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch" title="–ù–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ WB Manager">
                    <input type="checkbox" id="config-skip-autostart">
                    <span class="slider"></span>
                </label>
                <span style="font-size: 0.9rem;">–ù–µ –≤–∫–ª—é—á–∞—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ</span>
            </div>
            <div class="form-hint">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –±–æ—Ç –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ WB Manager.</div>
        </div>

        <div style="text-align: right;">
            <button class="btn btn-primary" id="btn-save-config">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </div>

    <!-- Maintenance Section -->
    <div class="config-section">
        <div class="section-title">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä</div>
        
        <div class="form-group">
            <label class="form-label">–ü–∞–ø–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" class="form-input" id="config-photo-dir" placeholder="photos">
                <button class="btn btn-secondary" id="btn-select-dir" title="–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É">üìÇ</button>
                <button class="btn btn-primary" id="btn-save-photo-dir">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
            <button class="btn btn-danger" id="btn-clear-photos" style="width: 100%;">–û—á–∏—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É</button>
        </div>
    </div>

    <!-- Users Management -->
    <div class="config-section">
        <div class="section-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <div class="form-group">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" class="form-input" id="new-user-input" placeholder="username (–±–µ–∑ @)">
                <input type="text" class="form-input" id="new-user-name" placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                <button class="btn btn-primary" id="btn-add-user">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
        <div class="users-list" id="users-list">
            <!-- Users will be injected here -->
        </div>
    </div>

    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∫–æ–º–∞–Ω–¥–∞–º Telegram-–±–æ—Ç–∞ -->
    <div class="config-section bot-instruction-section">
        <div class="section-title" style="display:flex;align-items:center;gap:10px;">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∫–æ–º–∞–Ω–¥–∞–º Telegram-–±–æ—Ç–∞
        </div>
        <div class="bot-instruction-list">
            <div class="bot-instruction-item">
                <span class="bot-instruction-icon">üì∏</span>
                <div>
                    <b>–§–æ—Ç–æ</b>: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é –∏–ª–∏ –±–µ–∑ ‚Äî –±–æ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç –µ–≥–æ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä. –ü–µ—Ä–≤—ã–µ 3 —Å–ª–æ–≤–∞ –ø–æ–¥–ø–∏—Å–∏ —Å—Ç–∞–Ω—É—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ñ–∞–π–ª–∞.
                </div>
            </div>
            <div class="bot-instruction-item">
                <span class="bot-instruction-icon">üöö</span>
                <div>
                    <b>–í –ø—É—Ç–∏</b>: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <code>–í –ø—É—Ç–∏</code> ‚Äî –ø–æ–ª—É—á–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ —Å–µ–π—á–∞—Å –≤ –ø—É—Ç–∏.
                </div>
            </div>
            <div class="bot-instruction-item">
                <span class="bot-instruction-icon">üìã</span>
                <div>
                    <b>–û—Ç—á—ë—Ç</b>: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <code>–û—Ç—á—ë—Ç</code> ‚Äî –ø–æ–ª—É—á–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å—Ç–∞–≤–æ–∫ –∏ –ø—Ä–∏—ë–º–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è.
                </div>
            </div>
            <div class="bot-instruction-item">
                <span class="bot-instruction-icon">‚è∞</span>
                <div>
                    <b>–í—Ä–µ–º—è –Ω–∞ –ø—Ä–∏–µ–º–∫—É</b>: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <code>–í—Ä–µ–º—è –Ω–∞ –ø—Ä–∏–µ–º–∫—É</code> ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –≤—Ä–µ–º—è, –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ—Å—Ç–∞–≤–∫—É.
                </div>
            </div>
            <div class="bot-instruction-item">
                <span class="bot-instruction-icon">üîê</span>
                <div>
                    <b>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è WB</b>: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX ‚Äî –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç–µ WB –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
                </div>
            </div>
            <div class="bot-instruction-item">
                <span class="bot-instruction-icon">üõ°Ô∏è</span>
                <div>
                    <b>–î–æ—Å—Ç—É–ø</b>: —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –º–æ–≥—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                </div>
            </div>
            <div class="bot-instruction-item admin-commands">
                <span class="bot-instruction-icon">‚öôÔ∏è</span>
                <div>
                    <b>–ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã</b> (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤):
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li><code>–¥–æ–±–∞–≤–∏—Ç—å username</code> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ @)</li>
                        <li><code>—É–¥–∞–ª–∏—Ç—å username</code> ‚Äî —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ @)</li>
                        <li><code>—Å—Ç–∞—Ç—É—Å</code> ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                        <li><code>–Ω–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ–º "–¥–∞–ª–µ–µ - –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫"</code> ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="bot-instruction-footer">
            –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö –ø—Ä–∏—Ö–æ–¥—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.
        </div>
    </div>
</div>
<style>
.bot-instruction-section {
    background: rgba(255,255,255,0.03);
    color: var(--text-primary);
    margin-top: 32px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 28px;
}

.bot-instruction-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin: 20px 0 16px 0;
}

.bot-instruction-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    font-size: 1.02rem;
    background: rgba(0,0,0,0.02);
    border-radius: 8px;
    padding: 12px 16px;
    border-left: 4px solid #3b82f6;
    border: 1px solid var(--border-color);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.bot-instruction-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
}

.bot-instruction-item.admin-commands {
    border-left-color: #f59e0b;
    background: rgba(245, 158, 11, 0.05);
}

.bot-instruction-item.admin-commands:hover {
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);
}

.bot-instruction-icon {
    font-size: 1.3em;
    width: 1.8em;
    text-align: center;
    flex-shrink: 0;
}

.bot-instruction-item ul {
    margin: 8px 0 0 0;
    padding-left: 20px;
}

.bot-instruction-item li {
    margin-bottom: 4px;
    color: var(--text-secondary);
}

.bot-instruction-item code {
    background: rgba(59, 130, 246, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9em;
}

.bot-instruction-footer {
    margin-top: 16px;
    font-size: 0.95rem;
    color: var(--text-secondary);
    padding: 12px;
    background: rgba(0,0,0,0.02);
    border-radius: 6px;
    border: 1px solid rgba(0,0,0,0.05);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    function togglePassword(id) {
        const el = document.getElementById(id);
        el.type = el.type === 'password' ? 'text' : 'password';
    }

    (function() {
        const els = {
            botBadge: document.getElementById('bot-status-badge'),
            botText: document.getElementById('bot-status-text'),
            authBadge: document.getElementById('auth-status-badge'),
            authText: document.getElementById('auth-status-text'),
            btnStart: document.getElementById('btn-start-bot'),
            btnStop: document.getElementById('btn-stop-bot'),
            btnRestart: document.getElementById('btn-restart-bot'),
            token: document.getElementById('config-token'),
            authMsg: document.getElementById('config-auth-msg'),
            photoDir: document.getElementById('config-photo-dir'),
            skipAutostart: document.getElementById('config-skip-autostart'),
            usersList: document.getElementById('users-list'),
            newUser: document.getElementById('new-user-input'),
            newUserName: document.getElementById('new-user-name'),
            btnAddUser: document.getElementById('btn-add-user'),
            btnSaveConfig: document.getElementById('btn-save-config'),
            btnSavePhotoDir: document.getElementById('btn-save-photo-dir'),
            btnClearPhotos: document.getElementById('btn-clear-photos'),
            btnSelectDir: document.getElementById('btn-select-dir')
        };

        let currentConfig = {};

        async function updateStatus() {
            try {
                const res = await fetch('/api/bot/status?t=' + Date.now());
                const data = await res.json();
                
                if (data.running) {
                    els.botBadge.className = 'status-badge running';
                    els.botText.textContent = '–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω';
                    els.btnStart.style.display = 'none';
                    els.btnStop.style.display = 'block';
                    
                    els.authBadge.style.display = 'inline-flex';
                    
                    const configRes = await fetch('/api/bot/config?t=' + Date.now());
                    const config = await configRes.json();
                    
                    if (config.is_authorized) {
                        els.authBadge.className = 'status-badge auth-ok';
                        els.authText.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –Ω–∞ WB';
                    } else {
                        els.authBadge.className = 'status-badge auth-fail';
                        els.authText.textContent = '–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ WB';
                    }
                    
                } else {
                    els.botBadge.className = 'status-badge stopped';
                    els.botText.textContent = '–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                    els.btnStart.style.display = 'block';
                    els.btnStop.style.display = 'none';
                    els.authBadge.style.display = 'none';
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadConfig() {
            try {
                const res = await fetch('/api/bot/config');
                currentConfig = await res.json();
                
                els.token.value = currentConfig.telegram_token || '';
                els.authMsg.value = currentConfig.auth_message || '';
                els.photoDir.value = currentConfig.photo_save_path || 'photos';
                els.skipAutostart.checked = !!currentConfig.skip_autostart;
                
                renderUsers();
            } catch (e) {
                console.error(e);
            }
        }

        function renderUsers() {
            els.usersList.innerHTML = '';
            const allowed = currentConfig.allowed_users || [];
            const notified = currentConfig.notification_enabled_users || [];
            const chatIds = currentConfig.user_chat_ids || {};
            const userNames = currentConfig.user_names || {};

            allowed.forEach(user => {
                const isNotified = notified.includes(user);
                const chatId = chatIds[user];
                const name = userNames[user] || '';
                
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `
                    <div class="user-info">
                        <div style="display: flex; flex-direction: column;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 600;">@${user}</span>
                                <input type="text" 
                                    class="form-input" 
                                    style="padding: 2px 5px; width: 150px; font-size: 0.9rem;" 
                                    placeholder="–ò–º—è" 
                                    value="${name}"
                                    onchange="updateUserName('${user}', this.value)"
                                >
                            </div>
                            <div style="margin-top: 4px; font-size: 0.85rem; color: var(--text-secondary);">
                                ${chatId ? 
                                    `<span style="color: var(--success-color);">‚óè –ê–∫—Ç–∏–≤–µ–Ω (ID: ${chatId})</span>` : 
                                    `<span style="color: var(--warning-color);">‚óã –ù–µ –ø–∏—Å–∞–ª –±–æ—Ç—É</span>`
                                }
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                            <label class="toggle-switch" title="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">
                                <input type="checkbox" ${currentConfig.admins && currentConfig.admins.includes(user) ? 'checked' : ''} onchange="toggleAdmin('${user}', this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">–ê–¥–º–∏–Ω</span>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end;">
                            <label class="toggle-switch" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ—Å—Ç–∞–≤–∫–∞—Ö">
                                <input type="checkbox" ${isNotified ? 'checked' : ''} onchange="toggleNotify('${user}', this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                        </div>
                        <button class="btn-icon" onclick="removeUser('${user}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </div>
                `;
                els.usersList.appendChild(div);
            });
        }

        window.updateUserName = async (user, name) => {
            if (!currentConfig.user_names) currentConfig.user_names = {};
            currentConfig.user_names[user] = name;
            await saveConfig(true);
        };

        window.toggleAdmin = async (user, enabled) => {
            let admins = currentConfig.admins || [];
            if (enabled) {
                if (!admins.includes(user)) admins.push(user);
            } else {
                admins = admins.filter(u => u !== user);
            }
            currentConfig.admins = admins;
            await saveConfig(true);
        };

        window.toggleNotify = async (user, enabled) => {
            let notified = currentConfig.notification_enabled_users || [];
            if (enabled) {
                if (!notified.includes(user)) notified.push(user);
            } else {
                notified = notified.filter(u => u !== user);
            }
            currentConfig.notification_enabled_users = notified;
            await saveConfig(true); // silent save
        };

        window.removeUser = async (user) => {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @${user}?`)) return;
            currentConfig.allowed_users = currentConfig.allowed_users.filter(u => u !== user);
            currentConfig.notification_enabled_users = currentConfig.notification_enabled_users.filter(u => u !== user);
            if (currentConfig.admins) {
                currentConfig.admins = currentConfig.admins.filter(u => u !== user);
            }
            if (currentConfig.user_names && currentConfig.user_names[user]) {
                delete currentConfig.user_names[user];
            }
            await saveConfig();
        };

        async function saveConfig(silent = false) {
            const newConfig = {
                ...currentConfig,
                telegram_token: els.token.value,
                auth_message: els.authMsg.value,
                photo_save_path: els.photoDir.value,
                skip_autostart: els.skipAutostart.checked
            };

            try {
                const res = await fetch('/api/bot/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(newConfig)
                });
                const result = await res.json();
                if (result.success) {
                    if (!silent) alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                    loadConfig(); // reload to sync
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
            }
        }

        // Event Listeners
        els.btnStart.onclick = async () => {
            await fetch('/api/bot/start', {method: 'POST'});
            setTimeout(updateStatus, 1000);
        };

        els.btnStop.onclick = async () => {
            await fetch('/api/bot/stop', {method: 'POST'});
            setTimeout(updateStatus, 1000);
        };

        els.btnRestart.onclick = async () => {
            await fetch('/api/bot/stop', {method: 'POST'});
            setTimeout(async () => {
                await fetch('/api/bot/start', {method: 'POST'});
                setTimeout(updateStatus, 1000);
            }, 2000);
        };

        els.btnSaveConfig.onclick = () => saveConfig();
        els.btnSavePhotoDir.onclick = () => saveConfig();
        els.skipAutostart.onchange = () => saveConfig(true);

        els.btnSelectDir.onclick = async () => {
            try {
                els.btnSelectDir.disabled = true;
                const res = await fetch('/api/utils/select-folder', {method: 'POST'});
                const data = await res.json();
                if (data.success && data.path) {
                    els.photoDir.value = data.path;
                }
            } catch (e) {
                console.error(e);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–∏–∞–ª–æ–≥–∞');
            } finally {
                els.btnSelectDir.disabled = false;
            }
        };

        els.btnAddUser.onclick = async () => {
            const user = els.newUser.value.trim().replace('@', '');
            const name = els.newUserName.value.trim();
            if (!user) return;
            
            if (!currentConfig.allowed_users) currentConfig.allowed_users = [];
            if (currentConfig.allowed_users.includes(user)) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω');
            
            currentConfig.allowed_users.push(user);
            
            if (name) {
                if (!currentConfig.user_names) currentConfig.user_names = {};
                currentConfig.user_names[user] = name;
            }

            // Enable notifications by default
            if (!currentConfig.notification_enabled_users) currentConfig.notification_enabled_users = [];
            currentConfig.notification_enabled_users.push(user);
            
            // First user is admin by default if no admins exist
            if (!currentConfig.admins || currentConfig.admins.length === 0) {
                currentConfig.admins = [user];
            }

            await saveConfig();
            els.newUser.value = '';
            els.newUserName.value = '';
        };

        els.btnClearPhotos.onclick = async () => {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ –ø–∞–ø–∫–∏?')) return;
            try {
                const res = await fetch('/api/bot/clear_photos', {method: 'POST'});
                const result = await res.json();
                if (result.success) {
                    alert(`–£–¥–∞–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${result.count}`);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
                }
            } catch (e) {
                alert(e.message);
            }
        };

        // Init
        loadConfig();
        updateStatus();
        setInterval(updateStatus, 5000);
    })();
</script>
{% endblock %}
